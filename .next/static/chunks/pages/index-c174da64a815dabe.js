(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{1249:(e,t,r)=>{"use strict";r.d(t,{db:()=>d,j:()=>s});var n=r(6042),o=r(9834),i=r(2964);let l=(0,n.Dk)().length?(0,n.Dk)()[0]:(0,n.Wp)({apiKey:"AIzaSyDGIRoQ7XG8SPUwYZI22bM6ahBqHqCESOI",authDomain:"chat-next-app-75486.firebaseapp.com",projectId:"chat-next-app-75486",storageBucket:"chat-next-app-75486.appspot.com",messagingSenderId:"699078787230",appId:"1:699078787230:web:5af28b86d937f5c553bb8f",measurementId:"G-NE519J21D1"}),s=(0,o.xI)(l),d=(0,i.aU)(l)},2617:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>ee});var n=r(7876),o=r(4232),i=r(9834),l=r(1249),s=r(9099),d=r(2964);let a=async(e,t,r)=>{let n={name:e,ownerId:t,members:[t],createdAt:(0,d.O5)(),channels:[],icon:null},o=await (0,d.gS)((0,d.rJ)(l.db,"servers"),n),i={};for(let e of E){let t=await (0,d.gS)((0,d.rJ)(l.db,"serverRoles"),{...e,serverId:o.id,createdAt:(0,d.O5)()});i[e.name]=t.id}return await y(o.id,t,r,[i["オーナー"]]),await p("一般","text",o.id,t),o.id};async function c(e){let t=(0,d.H9)(l.db,"users",e),r=await (0,d.x7)(t);return r.exists()?r.data():{}}let p=async(e,t,r,n)=>{let o={name:e,type:t,serverId:r,creatorId:n,createdAt:(0,d.O5)(),members:[],permissions:{}};return await (0,d.gS)((0,d.rJ)(l.db,"channels"),o)},x=async function(e,t,r,n){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i={channelId:e,userId:t,userName:r,content:n,timestamp:(0,d.O5)(),reactions:{},edited:!1,replyTo:o};return await (0,d.gS)((0,d.rJ)(l.db,"messages"),i)},u=async(e,t)=>{let r=(0,d.H9)(l.db,"messages",e);await (0,d.mZ)(r,{content:t,edited:!0,editedAt:(0,d.O5)()})},f=async e=>{await (0,d.kd)((0,d.H9)(l.db,"messages",e))},g=async(e,t,r)=>{let n=(0,d.H9)(l.db,"messages",e),o=(await (0,d.x7)(n)).data().reactions||{};o[r]||(o[r]=[]),o[r].includes(t)||o[r].push(t),await (0,d.mZ)(n,{reactions:o})},b=async(e,t,r)=>{let n=(0,d.H9)(l.db,"messages",e),o=(await (0,d.x7)(n)).data().reactions||{};o[r]&&(o[r]=o[r].filter(e=>e!==t),0===o[r].length&&delete o[r]),await (0,d.mZ)(n,{reactions:o})},h=async function(e,t,r,n){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;try{let i=(0,d.rJ)(l.db,"messages"),s={channelId:e,userId:t,userName:r,content:n,timestamp:(0,d.O5)(),edited:!1};if(o){let e=(0,d.H9)(l.db,"messages",o),t=await (0,d.x7)(e);t.exists()&&(s.replyTo=t.data().content.substring(0,50)+(t.data().content.length>50?"...":""),s.replyToId=o)}await (0,d.gS)(i,s);let a=(0,d.H9)(l.db,"channels",e);await (0,d.mZ)(a,{lastMessage:n.substring(0,50)+(n.length>50?"...":""),lastMessageAt:(0,d.O5)(),lastMessageUserId:t,lastMessageUserName:r}),console.log("DMメッセージ送信完了")}catch(e){throw console.error("DMメッセージ送信エラー:",e),e}},y=async function(e,t,r){var n;let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],i=(0,d.P)((0,d.rJ)(l.db,"serverRoles"),(0,d._M)("serverId","==",e),(0,d._M)("isDefault","==",!0)),s=null==(n=(await (0,d.GG)(i)).docs[0])?void 0:n.id,a={serverId:e,uid:t,displayName:r,roles:o.length>0?o:s?[s]:[],joinedAt:(0,d.O5)(),avatar:null},c=(0,d.H9)(l.db,"servers",e);return await (0,d.mZ)(c,{members:(0,d.hq)(t)}),await (0,d.gS)((0,d.rJ)(l.db,"serverMembers"),a)},m=async(e,t,r)=>{let n=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e),(0,d._M)("uid","==",t)),o=await (0,d.GG)(n);if(!o.empty){let e=o.docs[0];await (0,d.mZ)(e.ref,{roles:r})}},S=async(e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e),(0,d._M)("uid","==",t)),n=await (0,d.GG)(r);if(n.empty)return[];let o=n.docs[0].data().roles||[];if(0===o.length)return[];let i=(0,d.P)((0,d.rJ)(l.db,"serverRoles"),(0,d._M)("serverId","==",e)),s=(await (0,d.GG)(i)).docs.map(e=>({id:e.id,...e.data()})).filter(e=>o.includes(e.id)),a=new Set;return s.forEach(e=>{e.permissions&&e.permissions.forEach(e=>a.add(e))}),Array.from(a)},v=(e,t)=>e.includes(C.ADMINISTRATOR)||e.includes(t),j=async(e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e),(0,d._M)("uid","==",t)),n=await (0,d.GG)(r);n.empty||await (0,d.kd)(n.docs[0].ref);let o=(0,d.H9)(l.db,"servers",e);await (0,d.mZ)(o,{members:(0,d.C3)(t)})},C={ADMINISTRATOR:"administrator",MANAGE_SERVER:"manage_server",MANAGE_ROLES:"manage_roles",MANAGE_CHANNELS:"manage_channels",SEND_MESSAGES:"send_messages",EDIT_DELETE_MESSAGES:"edit_delete_messages",PIN_MESSAGES:"pin_messages",EMBED_LINKS:"embed_links",ATTACH_FILES:"attach_files",MENTION_EVERYONE:"mention_everyone",USE_EXTERNAL_EMOJIS:"use_external_emojis",VIEW_MEMBERS:"view_members",ADD_FRIENDS:"add_friends",MANAGE_MEMBERS:"manage_members",ASSIGN_ROLES:"assign_roles"},E=[{name:"オーナー",color:"#f04747",permissions:Object.values(C),position:100,isDefault:!1,canBeDeleted:!1},{name:"管理者",color:"#f04747",permissions:[C.MANAGE_SERVER,C.MANAGE_ROLES,C.MANAGE_CHANNELS,C.SEND_MESSAGES,C.EDIT_DELETE_MESSAGES,C.PIN_MESSAGES,C.EMBED_LINKS,C.ATTACH_FILES,C.MENTION_EVERYONE,C.USE_EXTERNAL_EMOJIS,C.VIEW_MEMBERS,C.MANAGE_MEMBERS,C.ASSIGN_ROLES],position:90,isDefault:!1,canBeDeleted:!0},{name:"モデレーター",color:"#5865f2",permissions:[C.SEND_MESSAGES,C.EDIT_DELETE_MESSAGES,C.PIN_MESSAGES,C.EMBED_LINKS,C.ATTACH_FILES,C.VIEW_MEMBERS,C.MANAGE_MEMBERS],position:80,isDefault:!1,canBeDeleted:!0},{name:"@everyone",color:"#99aab5",permissions:[C.SEND_MESSAGES,C.EMBED_LINKS,C.ATTACH_FILES,C.VIEW_MEMBERS,C.ADD_FRIENDS],position:0,isDefault:!0,canBeDeleted:!1}],w=async e=>{try{let t=(0,d.P)((0,d.rJ)(l.db,"users"),(0,d._M)("email","==",e.toLowerCase().trim())),r=await (0,d.GG)(t),n={};return r.docs.forEach(e=>{let t=e.data(),r=t.email.toLowerCase().trim();n[r]||(n[r]={id:e.id,...t})}),Object.values(n)}catch(e){return console.error("ユーザー検索エラー:",e),[]}},k=async(e,t,r)=>{let n=await w(t);if(0===n.length){let n={serverId:e,userId:null,userEmail:t,userName:null,inviterName:r,status:"pending",type:"email_invite",createdAt:(0,d.O5)()};return await (0,d.gS)((0,d.rJ)(l.db,"serverInvites"),n)}let o=n[0],i=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e),(0,d._M)("uid","==",o.uid||o.id));if(!(await (0,d.GG)(i)).empty)throw Error("このユーザーは既にサーバーのメンバーです");let s={serverId:e,userId:o.uid||o.id,userEmail:o.email,userName:o.displayName||"匿名",inviterName:r,status:"pending",type:"user_invite",createdAt:(0,d.O5)()};return await (0,d.gS)((0,d.rJ)(l.db,"serverInvites"),s)},I=async(e,t,r)=>{try{let n=(0,d.rJ)(l.db,"users"),o=(0,d.P)(n,(0,d._M)("tags","array-contains",t)),i=await (0,d.GG)(o);if(i.empty)throw Error('タグ "'.concat(t,'" を持つユーザーが見つかりません'));let s=[];return i.forEach(n=>{let o=n.data(),i=n.id,a=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e),(0,d._M)("uid","==",i));s.push((0,d.GG)(a).then(n=>n.empty?(0,d.gS)((0,d.rJ)(l.db,"serverInvites"),{serverId:e,userId:i,userEmail:o.email,userName:o.displayName||"匿名",inviterName:r,status:"pending",type:"tag_invite",tag:t,createdAt:(0,d.O5)()}):null))}),await Promise.all(s),console.log('タグ "'.concat(t,'" のユーザーを招待しました')),!0}catch(e){throw console.error("タグ別招待エラー:",e),e}},R=async(e,t,r,n)=>{await y(t,r,n),await (0,d.kd)((0,d.H9)(l.db,"serverInvites",e))},D=async e=>{await (0,d.kd)((0,d.H9)(l.db,"serverInvites",e))},M=async(e,t)=>{let r=(0,d.H9)(l.db,"users",e);try{(await (0,d.x7)(r)).exists()?await (0,d.mZ)(r,{...t,lastLogin:(0,d.O5)()}):await (0,d.BN)(r,{uid:e,...t,tags:[],avatar:null,status:"online",createdAt:(0,d.O5)(),lastLogin:(0,d.O5)()}),console.log("ユーザー情報保存完了:",e)}catch(n){console.error("ユーザー情報保存エラー:",n);try{await (0,d.BN)(r,{uid:e,...t,tags:[],avatar:null,status:"online",createdAt:(0,d.O5)(),lastLogin:(0,d.O5)()}),console.log("ユーザー情報新規作成完了:",e)}catch(e){throw console.error("ユーザー情報新規作成エラー:",e),e}}},_=async(e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"users"),(0,d._M)("uid","==",e)),n=await (0,d.GG)(r);if(!n.empty){let e=n.docs[0];await (0,d.mZ)(e.ref,{tags:t,updatedAt:(0,d.O5)()})}},A=async e=>{try{let t=(0,d.rJ)(l.db,"users"),r=(0,d.P)(t,(0,d._M)("tags","array-contains",e));return(await (0,d.GG)(r)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("タグ別ユーザー検索エラー:",e),[]}},z=async()=>{try{let e=(0,d.rJ)(l.db,"users"),t=await (0,d.GG)(e),r=new Set;return t.forEach(e=>{(e.data().tags||[]).forEach(e=>r.add(e))}),Array.from(r)}catch(e){return console.error("タグ取得エラー:",e),[]}},N=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"images";return new Promise((r,n)=>{let o=new FileReader;o.onload=async()=>{try{let n={data:o.result,name:e.name,type:e.type,size:e.size,folder:t,uploadedAt:(0,d.O5)()},i=await (0,d.gS)((0,d.rJ)(l.db,"images"),n);r({id:i.id,url:o.result,name:e.name,type:e.type})}catch(e){n(e)}},o.onerror=n,o.readAsDataURL(e)})},B=async e=>{let t=await (0,d.x7)((0,d.H9)(l.db,"images",e));return t.exists()?{id:t.id,...t.data()}:null},G=async(e,t)=>{let r=(0,d.H9)(l.db,"servers",e);await (0,d.mZ)(r,{icon:t})},O=async(e,t)=>{let r=await (0,d.x7)((0,d.H9)(l.db,"servers",e));if(!r.exists())throw Error("サーバーが見つかりません");if(r.data().ownerId!==t)throw Error("サーバーを削除する権限がありません");let n=(0,d.P)((0,d.rJ)(l.db,"channels"),(0,d._M)("serverId","==",e));for(let e of(await (0,d.GG)(n)).docs){await (0,d.kd)(e.ref);let t=(0,d.P)((0,d.rJ)(l.db,"messages"),(0,d._M)("channelId","==",e.id));for(let e of(await (0,d.GG)(t)).docs)await (0,d.kd)(e.ref)}let o=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e));for(let e of(await (0,d.GG)(o)).docs)await (0,d.kd)(e.ref);let i=(0,d.P)((0,d.rJ)(l.db,"serverRoles"),(0,d._M)("serverId","==",e));for(let e of(await (0,d.GG)(i)).docs)await (0,d.kd)(e.ref);let s=(0,d.P)((0,d.rJ)(l.db,"serverInvites"),(0,d._M)("serverId","==",e));for(let e of(await (0,d.GG)(s)).docs)await (0,d.kd)(e.ref);await (0,d.kd)((0,d.H9)(l.db,"servers",e))},T=async function(e,t,r,n,o){let i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s={channelId:e,userId:t,userName:r,content:n,timestamp:(0,d.O5)(),reactions:{},edited:!1,replyTo:i,attachments:o?[{type:"image",id:o}]:[]};return await (0,d.gS)((0,d.rJ)(l.db,"messages"),s)},W=async(e,t)=>{let r={serverId:e,...t,createdAt:(0,d.O5)()};return await (0,d.gS)((0,d.rJ)(l.db,"serverRoles"),r)},L=async(e,t)=>{let r=(0,d.H9)(l.db,"serverRoles",e);await (0,d.mZ)(r,t)},H=async e=>{await (0,d.kd)((0,d.H9)(l.db,"serverRoles",e))};function P(e){let{onImageUploaded:t,folder:r="images",multiple:i=!1}=e,[l,s]=(0,o.useState)(!1),[d,a]=(0,o.useState)(!1),[c,p]=(0,o.useState)(null),x=(0,o.useRef)(null),u=e=>e.size>0xa00000?(alert("ファイルサイズは10MB以下にしてください"),!1):!!["image/jpeg","image/png","image/gif","image/webp"].includes(e.type)||(alert("JPEG、PNG、GIF、WebP形式の画像のみアップロード可能です"),!1),f=async e=>{if(e&&u(e)){let n=new FileReader;n.onload=e=>{p(e.target.result)},n.readAsDataURL(e),s(!0);try{let n=await N(e,r);t(n)}catch(e){console.error("アップロードエラー:",e),alert("画像のアップロードに失敗しました")}finally{s(!1),p(null)}}},g=async e=>{if(!i)return void f(e[0]);let n=Array.from(e).filter(u);if(0!==n.length){s(!0);try{let e=n.map(e=>N(e,r));(await Promise.all(e)).forEach(e=>t(e))}catch(e){console.error("アップロードエラー:",e),alert("画像のアップロードに失敗しました")}finally{s(!1)}}};return(0,n.jsxs)("div",{children:[(0,n.jsx)("input",{type:"file",accept:"image/jpeg, image/png, image/gif, image/webp",onChange:e=>{let t=e.target.files;t&&t.length>0&&(i?g(t):f(t[0]))},style:{display:"none"},id:"image-upload",disabled:l,multiple:i,ref:x}),(0,n.jsx)("div",{onDrop:e=>{e.preventDefault(),a(!1);let t=Array.from(e.dataTransfer.files);t.length>0&&(i?g(t):f(t[0]))},onDragOver:e=>{e.preventDefault(),a(!0)},onDragLeave:()=>{a(!1)},onClick:()=>!l&&x.current.click(),style:{border:"2px dashed ".concat(d?"#5865f2":"#40444b"),borderRadius:"8px",padding:"20px",textAlign:"center",cursor:l?"not-allowed":"pointer",backgroundColor:d?"rgba(88, 101, 242, 0.1)":"#2f3136",color:"#dcddde",transition:"all 0.2s ease"},children:l?(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{style:{fontSize:"20px",marginBottom:"8px"},children:"⏳"}),(0,n.jsx)("div",{children:"アップロード中..."})]}):c?(0,n.jsx)("img",{src:c,alt:"プレビュー",style:{maxWidth:"100%",maxHeight:"200px"}}):(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{style:{fontSize:"20px",marginBottom:"8px"},children:"\uD83D\uDCF7"}),(0,n.jsx)("div",{children:"クリックまたはドラッグ&ドロップで画像をアップロード"}),(0,n.jsxs)("div",{style:{fontSize:"12px",color:"#72767d",marginTop:"4px"},children:["最大 10MB / ",i?"複数ファイル可":"1ファイルのみ"]})]})})]})}function J(e){let{servers:t,currentServer:r,onServerSelect:i,onCreateServer:l,onDeleteServer:s,onUpdateServerIcon:d,currentUser:a}=e,[c,p]=(0,o.useState)(!1),[x,u]=(0,o.useState)(""),[f,g]=(0,o.useState)(null),[b,h]=(0,o.useState)(null),y=async()=>{x.trim()&&(await l(x.trim()),u(""),p(!1))};return(0,n.jsxs)("div",{style:{width:"72px",backgroundColor:"#202225",padding:"12px 0",display:"flex",flexDirection:"column",alignItems:"center",borderRight:"1px solid #36393f",position:"relative"},children:[(0,n.jsx)("div",{onClick:()=>i("dm"),style:{width:"48px",height:"48px",backgroundColor:"dm"===r?"#5865f2":"#36393f",borderRadius:"dm"===r?"16px":"24px",display:"flex",alignItems:"center",justifyContent:"center",marginBottom:"8px",cursor:"pointer",transition:"all 0.2s ease",color:"white",fontSize:"24px",border:"dm"===r?"2px solid #ffffff":"none",position:"relative"},onMouseOver:e=>{"dm"!==r&&(e.target.style.backgroundColor="#5865f2",e.target.style.borderRadius="16px")},onMouseOut:e=>{"dm"!==r&&(e.target.style.backgroundColor="#36393f",e.target.style.borderRadius="24px")},title:"ダイレクトメッセージ",children:"\uD83D\uDCAC"}),(0,n.jsx)("div",{style:{width:"32px",height:"2px",backgroundColor:"#36393f",marginBottom:"8px",borderRadius:"1px"}}),t.map(e=>(0,n.jsxs)("div",{style:{position:"relative",marginBottom:"8px"},children:[(0,n.jsxs)("div",{onClick:()=>i(e.id),onContextMenu:t=>{t.preventDefault(),g(f===e.id?null:e.id)},style:{width:"48px",height:"48px",backgroundColor:r===e.id?"#5865f2":"#36393f",borderRadius:r===e.id?"16px":"24px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all 0.2s ease",color:"white",fontSize:"16px",fontWeight:"600",border:r===e.id?"2px solid #ffffff":"none",overflow:"hidden",position:"relative",backgroundImage:e.icon||e.iconUrl?"url(".concat(e.icon||e.iconUrl,")"):"none",backgroundSize:"cover",backgroundPosition:"center"},onMouseOver:t=>{r!==e.id&&(t.target.style.backgroundColor="#5865f2",t.target.style.borderRadius="16px")},onMouseOut:t=>{r!==e.id&&(t.target.style.backgroundColor="#36393f",t.target.style.borderRadius="24px")},title:e.name,children:[!(e.icon||e.iconUrl)&&e.name.charAt(0).toUpperCase(),r===e.id&&(0,n.jsx)("div",{style:{position:"absolute",left:"-8px",top:"50%",transform:"translateY(-50%)",width:"4px",height:"40px",backgroundColor:"#ffffff",borderRadius:"0 2px 2px 0"}})]}),f===e.id&&(0,n.jsxs)("div",{style:{position:"absolute",left:"60px",top:"0px",backgroundColor:"#18191c",borderRadius:"4px",padding:"8px 0",minWidth:"150px",boxShadow:"0 8px 16px rgba(0, 0, 0, 0.24)",zIndex:1e3,border:"1px solid #40444b"},children:[(0,n.jsx)("button",{onClick:()=>{h(e.id),g(null)},style:{width:"100%",padding:"8px 12px",backgroundColor:"transparent",border:"none",color:"#dcddde",textAlign:"left",cursor:"pointer",fontSize:"14px"},onMouseOver:e=>e.target.style.backgroundColor="#40444b",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:"アイコン変更"}),e.ownerId===(null==a?void 0:a.uid)&&s&&(0,n.jsx)("button",{onClick:()=>{window.confirm('サーバー "'.concat(e.name,'" を削除しますか？この操作は取り消せません。'))&&s(e.id),g(null)},style:{width:"100%",padding:"8px 12px",backgroundColor:"transparent",border:"none",color:"#ed4245",textAlign:"left",cursor:"pointer",fontSize:"14px"},onMouseOver:e=>e.target.style.backgroundColor="#40444b",onMouseOut:e=>e.target.style.backgroundColor="transparent",children:"サーバー削除"})]})]},e.id)),(0,n.jsx)("div",{onClick:()=>p(!0),style:{width:"48px",height:"48px",backgroundColor:"#36393f",borderRadius:"24px",display:"flex",alignItems:"center",justifyContent:"center",marginTop:"8px",cursor:"pointer",transition:"all 0.2s ease",color:"#3ba55c",fontSize:"24px",border:"2px dashed #3ba55c"},onMouseOver:e=>{e.target.style.backgroundColor="#3ba55c",e.target.style.color="#ffffff",e.target.style.borderRadius="16px",e.target.style.border="2px solid #3ba55c"},onMouseOut:e=>{e.target.style.backgroundColor="#36393f",e.target.style.color="#3ba55c",e.target.style.borderRadius="24px",e.target.style.border="2px dashed #3ba55c"},title:"サーバーを追加",children:"➕"}),c&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"440px",maxWidth:"90vw"},children:[(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"24px",fontWeight:"600",margin:"0 0 8px 0"},children:"サーバーを作成"}),(0,n.jsx)("p",{style:{color:"#b9bbbe",fontSize:"16px",margin:"0 0 20px 0"},children:"サーバーとは、友達と集まるスペースです。自分のサーバーを作って、話し始めましょう。"}),(0,n.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"12px",fontWeight:"600",textTransform:"uppercase",display:"block",marginBottom:"8px"},children:"サーバー名"}),(0,n.jsx)("input",{type:"text",value:x,onChange:e=>u(e.target.value),placeholder:"サーバー名を入力",maxLength:50,style:{width:"100%",padding:"12px",backgroundColor:"#202225",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"16px",marginBottom:"16px",boxSizing:"border-box",outline:"none"},onKeyDown:e=>{"Enter"===e.key&&y()},autoFocus:!0})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>{p(!1),u("")},style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"12px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:y,disabled:!x.trim(),style:{backgroundColor:x.trim()?"#5865f2":"#4f545c",border:"none",color:"white",padding:"12px 16px",borderRadius:"4px",cursor:x.trim()?"pointer":"not-allowed",fontSize:"14px",fontWeight:"500"},children:"作成"})]})]})}),b&&d&&(0,n.jsx)(P,{onUpload:e=>{d(b,e.id),h(null)},onClose:()=>h(null)}),f&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:999},onClick:()=>g(null)})]})}function U(e){let{server:t,channels:r,currentChannel:i,onChannelSelect:l,onCreateChannel:s,user:d,voiceParticipants:a=[],speakingUsers:c=new Set,isMuted:p=!1}=e,[x,u]=(0,o.useState)(!1),[f,g]=(0,o.useState)(""),[b,h]=(0,o.useState)("text"),y=()=>{f.trim()&&(s({name:f.trim(),type:b,serverId:t.id}),g(""),u(!1))},m=r.filter(e=>"text"===e.type||!e.type),S=r.filter(e=>"voice"===e.type);return(null==t?void 0:t.id)==="dm"?(0,n.jsxs)("div",{style:{width:"240px",backgroundColor:"#2f3136",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:{padding:"12px 16px",borderBottom:"1px solid #202225",color:"white",fontWeight:"600",fontSize:"16px"},children:"ダイレクトメッセージ"}),(0,n.jsx)("div",{style:{padding:"16px",flex:1},children:(0,n.jsx)("p",{style:{color:"#b9bbbe",fontSize:"14px"},children:"フレンド機能は開発中です..."})})]}):(0,n.jsxs)("div",{style:{width:"240px",backgroundColor:"#2f3136",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("style",{children:"\n                @keyframes pulse {\n                    0% { opacity: 1; transform: scale(1); }\n                    50% { opacity: 0.5; transform: scale(1.2); }\n                    100% { opacity: 1; transform: scale(1); }\n                }\n            "}),(0,n.jsxs)("div",{style:{padding:"12px 16px",borderBottom:"1px solid #202225",color:"white",fontWeight:"600",fontSize:"16px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"},children:[(null==t?void 0:t.name)||"サーバー",(0,n.jsx)("span",{style:{fontSize:"18px"},children:"⌄"})]}),(0,n.jsxs)("div",{style:{flex:1,overflowY:"auto"},children:[(0,n.jsxs)("div",{style:{margin:"16px 0 8px 0"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 8px 0 16px",color:"#8e9297",fontSize:"12px",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.02em",cursor:"pointer"},children:[(0,n.jsx)("span",{children:"テキストチャンネル"}),(0,n.jsx)("button",{onClick:()=>{h("text"),u(!0)},style:{background:"none",border:"none",color:"#8e9297",cursor:"pointer",fontSize:"18px",padding:"4px",borderRadius:"4px"},onMouseOver:e=>e.target.style.color="#dcddde",onMouseOut:e=>e.target.style.color="#8e9297",children:"+"})]}),m.map(e=>(0,n.jsxs)("div",{onClick:()=>l(e.id),style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 8px 6px 16px",margin:"1px 8px",borderRadius:"4px",cursor:"pointer",backgroundColor:i===e.id?"#5865f2":"transparent",color:i===e.id?"#ffffff":"#8e9297",transition:"all 0.15s ease"},onMouseOver:t=>{i!==e.id&&(t.target.style.backgroundColor="#40444b",t.target.style.color="#dcddde")},onMouseOut:t=>{i!==e.id&&(t.target.style.backgroundColor="transparent",t.target.style.color="#8e9297")},children:[(0,n.jsx)("span",{style:{fontSize:"20px"},children:"#"}),(0,n.jsx)("span",{style:{fontSize:"16px"},children:e.name})]},e.id))]}),(0,n.jsxs)("div",{style:{margin:"24px 0 8px 0"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 8px 0 16px",color:"#8e9297",fontSize:"12px",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.02em",cursor:"pointer"},children:[(0,n.jsx)("span",{children:"ボイスチャンネル"}),(0,n.jsx)("button",{onClick:()=>{h("voice"),u(!0)},style:{background:"none",border:"none",color:"#8e9297",cursor:"pointer",fontSize:"18px",padding:"4px",borderRadius:"4px"},onMouseOver:e=>e.target.style.color="#dcddde",onMouseOut:e=>e.target.style.color="#8e9297",children:"+"})]}),S.map(e=>{let t=a.filter(t=>t.channelId===e.id),r=i===e.id;return(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{onClick:()=>l(e.id),style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 8px 6px 16px",margin:"1px 8px",borderRadius:"4px",cursor:"pointer",backgroundColor:r?"#5865f2":"transparent",color:r?"#ffffff":"#8e9297",transition:"all 0.15s ease"},onMouseOver:e=>{r||(e.target.style.backgroundColor="#40444b",e.target.style.color="#dcddde")},onMouseOut:e=>{r||(e.target.style.backgroundColor="transparent",e.target.style.color="#8e9297")},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("span",{style:{fontSize:"20px"},children:"\uD83D\uDD0A"}),(0,n.jsx)("span",{style:{fontSize:"16px"},children:e.name})]}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsx)("span",{style:{fontSize:"14px",cursor:"pointer"},children:"\uD83D\uDCAC"}),(0,n.jsx)("span",{style:{fontSize:"14px",cursor:"pointer"},children:"\uD83D\uDC65"}),(0,n.jsx)("span",{style:{fontSize:"14px",cursor:"pointer"},children:"⚙️"})]})]}),t.length>0&&(0,n.jsx)("div",{style:{padding:"0 16px 8px 32px"},children:t.map(e=>(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 8px",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.15s ease"},onMouseOver:e=>e.target.style.backgroundColor="#40444b",onMouseOut:e=>e.target.style.backgroundColor="transparent",title:e.userName,children:[(0,n.jsx)("div",{style:{width:"20px",height:"20px",borderRadius:"50%",backgroundColor:e.userId===(null==d?void 0:d.uid)?"#5865f2":"#43b581",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"10px",fontWeight:"600"},children:e.userName.charAt(0).toUpperCase()}),(0,n.jsx)("span",{style:{color:"#8e9297",fontSize:"14px",flex:1},children:e.userName}),(0,n.jsx)("span",{style:{color:"#8e9297",fontSize:"12px"},children:e.userId===(null==d?void 0:d.uid)?p?"\uD83D\uDD07":"\uD83C\uDFA4":"\uD83D\uDD07"})]},e.userId))})]},e.id)})]})]}),d&&(0,n.jsxs)("div",{style:{backgroundColor:"#232428",padding:"8px",display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"14px",fontWeight:"600"},children:(d.displayName||"匿").charAt(0).toUpperCase()}),(0,n.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,n.jsx)("div",{style:{color:"#ffffff",fontSize:"14px",fontWeight:"600",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:d.displayName||"匿名"}),(0,n.jsx)("div",{style:{color:"#b9bbbe",fontSize:"12px"},children:"オンライン"})]})]}),x&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"440px",maxWidth:"90vw"},children:[(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"24px",fontWeight:"600",margin:"0 0 20px 0"},children:"チャンネルを作成"}),(0,n.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"12px",fontWeight:"600",textTransform:"uppercase",display:"block",marginBottom:"8px"},children:"チャンネルタイプ"}),(0,n.jsxs)("div",{style:{display:"flex",gap:"12px"},children:[(0,n.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#dcddde",cursor:"pointer"},children:[(0,n.jsx)("input",{type:"radio",value:"text",checked:"text"===b,onChange:e=>h(e.target.value)}),"# テキスト"]}),(0,n.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#dcddde",cursor:"pointer"},children:[(0,n.jsx)("input",{type:"radio",value:"voice",checked:"voice"===b,onChange:e=>h(e.target.value)}),"\uD83D\uDD0A ボイス"]})]})]}),(0,n.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"12px",fontWeight:"600",textTransform:"uppercase",display:"block",marginBottom:"8px"},children:"チャンネル名"}),(0,n.jsx)("input",{type:"text",value:f,onChange:e=>g(e.target.value),placeholder:"新しいチャンネル",style:{width:"100%",padding:"10px",backgroundColor:"#202225",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"16px",outline:"none"},onKeyDown:e=>{"Enter"===e.key&&y()},autoFocus:!0})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>{u(!1),g("")},style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"12px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:y,disabled:!f.trim(),style:{backgroundColor:f.trim()?"#5865f2":"#4f545c",border:"none",color:"white",padding:"12px 16px",borderRadius:"4px",cursor:f.trim()?"pointer":"not-allowed",fontSize:"14px",fontWeight:"500"},children:"作成"})]})]})})]})}function F(e,t,r){try{let n=(0,d.rJ)(l.db,"friends"),o=(0,d.P)(n,(0,d._M)("participants","array-contains",e),(0,d._M)("status","==","accepted"));return(0,d.aQ)(o,t,r)}catch(e){console.error("フレンド取得エラー:",e),r&&r(e)}}let V={ADMINISTRATOR:"administrator",MANAGE_SERVER:"manage_server",MANAGE_ROLES:"manage_roles",MANAGE_CHANNELS:"manage_channels",SEND_MESSAGES:"send_messages",EDIT_DELETE_MESSAGES:"edit_delete_messages",PIN_MESSAGES:"pin_messages",EMBED_LINKS:"embed_links",ATTACH_FILES:"attach_files",MENTION_EVERYONE:"mention_everyone",USE_EXTERNAL_EMOJIS:"use_external_emojis",VIEW_MEMBERS:"view_members",ADD_FRIENDS:"add_friends",MANAGE_MEMBERS:"manage_members",ASSIGN_ROLES:"assign_roles"};function K(e){let{user:t,onClose:r,onSendFriendRequest:i,onCreateDM:l,isFriend:s}=e,[d,a]=(0,o.useState)(!1),c=async()=>{a(!0),await i(t.uid),a(!1)},p=async()=>{a(!0),await l(t.uid),a(!1),r()};return(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"400px",maxWidth:"90vw"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"20px",fontWeight:"600",margin:0},children:"ユーザープロフィール"}),(0,n.jsx)("button",{onClick:r,style:{background:"none",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"18px"},children:"✕"})]}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"16px",marginBottom:"24px"},children:[(0,n.jsx)("div",{style:{width:"64px",height:"64px",borderRadius:"50%",backgroundColor:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px",fontWeight:"600",color:"white"},children:(t.displayName||"匿").charAt(0).toUpperCase()}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{style:{color:"#ffffff",fontSize:"18px",fontWeight:"600",margin:"0 0 4px 0"},children:t.displayName||"匿名"}),(0,n.jsx)("p",{style:{color:"#b9bbbe",fontSize:"14px",margin:0},children:t.email})]})]}),(0,n.jsx)("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:s?(0,n.jsx)("button",{onClick:p,disabled:d,style:{backgroundColor:"#3ba55c",color:"white",border:"none",padding:"10px 16px",borderRadius:"4px",cursor:d?"not-allowed":"pointer",fontSize:"14px",fontWeight:"500"},children:d?"処理中...":"メッセージを送る"}):(0,n.jsx)("button",{onClick:c,disabled:d,style:{backgroundColor:"#5865f2",color:"white",border:"none",padding:"10px 16px",borderRadius:"4px",cursor:d?"not-allowed":"pointer",fontSize:"14px",fontWeight:"500"},children:d?"送信中...":"フレンド申請"})})]})})}function Y(e){let{server:t,currentUser:r,onClose:i}=e,[s,a]=(0,o.useState)([]),[c,p]=(0,o.useState)(null),[x,u]=(0,o.useState)(!0);(0,o.useEffect)(()=>{if(!(null==t?void 0:t.id))return;let e=((e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"serverMembers"),(0,d._M)("serverId","==",e));return(0,d.aQ)(r,t)})(t.id,e=>{a(e.docs.map(e=>({id:e.id,...e.data()}))),u(!1)});return()=>e()},[null==t?void 0:t.id]);let f=async(e,r)=>{await m(t.id,e,[r])},g=async e=>{confirm("このメンバーをサーバーから削除しますか？")&&await j(t.id,e)},b=(null==t?void 0:t.ownerId)===(null==r?void 0:r.uid);return(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"600px",maxWidth:"90vw",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[(0,n.jsxs)("h2",{style:{color:"#ffffff",fontSize:"20px",fontWeight:"600",margin:0},children:["メンバー一覧 - ",null==t?void 0:t.name]}),(0,n.jsx)("button",{onClick:i,style:{background:"none",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"18px"},children:"✕"})]}),x?(0,n.jsx)("div",{style:{color:"#b9bbbe",textAlign:"center",padding:"20px"},children:"読み込み中..."}):(0,n.jsx)("div",{style:{flex:1,overflowY:"auto"},children:s.map(e=>(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",backgroundColor:"#2f3136",borderRadius:"4px",marginBottom:"8px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px",cursor:"pointer"},onClick:()=>p(e),children:[(0,n.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",backgroundColor:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"16px",fontWeight:"600",color:"white"},children:(e.displayName||"匿").charAt(0).toUpperCase()}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{style:{color:"#ffffff",fontSize:"16px",fontWeight:"500"},children:[e.displayName||"匿名",e.uid===t.ownerId&&(0,n.jsx)("span",{style:{color:"#faa61a",fontSize:"12px",marginLeft:"8px"},children:"\uD83D\uDC51 オーナー"})]}),(0,n.jsx)("div",{style:{color:"#b9bbbe",fontSize:"14px"},children:e.role||"メンバー"})]})]}),b&&e.uid!==r.uid&&(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,n.jsxs)("select",{value:e.role||"member",onChange:t=>f(e.uid,t.target.value),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",padding:"4px 8px",fontSize:"12px"},children:[(0,n.jsx)("option",{value:"member",children:"メンバー"}),(0,n.jsx)("option",{value:"moderator",children:"モデレーター"}),(0,n.jsx)("option",{value:"admin",children:"管理者"})]}),(0,n.jsx)("button",{onClick:()=>g(e.uid),style:{backgroundColor:"#ed4245",color:"white",border:"none",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px"},children:"削除"})]})]},e.id))}),c&&(0,n.jsx)(K,{user:c,onClose:()=>p(null),onSendFriendRequest:()=>{},onCreateDM:()=>{},isFriend:!1})]})})}function Z(e){let{user:t}=e,[r,i]=(0,o.useState)([]);(0,o.useEffect)(()=>{if(!t)return;let e=((e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"serverInvites"),(0,d._M)("userId","==",e),(0,d._M)("status","==","pending"));return(0,d.aQ)(r,t)})(t.uid,e=>{i(e.docs.map(e=>({id:e.id,...e.data()})))});return()=>e()},[t]);let s=async e=>{try{await R(e.id,e.serverId,t.uid,t.displayName||"匿名")}catch(e){console.error("招待受諾エラー:",e),alert("招待の受諾に失敗しました")}},a=async e=>{try{await D(e)}catch(e){console.error("招待拒否エラー:",e),alert("招待の拒否に失敗しました")}};return 0===r.length?null:(0,n.jsxs)("div",{style:{position:"fixed",top:"20px",right:"20px",backgroundColor:"#36393f",border:"1px solid #40444b",borderRadius:"8px",padding:"16px",maxWidth:"300px",zIndex:1e3},children:[(0,n.jsxs)("h3",{style:{color:"#ffffff",fontSize:"16px",margin:"0 0 12px 0"},children:["サーバー招待 (",r.length,")"]}),r.map(e=>(0,n.jsxs)("div",{style:{backgroundColor:"#2f3136",borderRadius:"4px",padding:"12px",marginBottom:"8px"},children:[(0,n.jsxs)("div",{style:{color:"#dcddde",fontSize:"14px",marginBottom:"8px"},children:[(0,n.jsx)("strong",{children:e.inviterName})," があなたをサーバーに招待しました"]}),(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,n.jsx)("button",{onClick:()=>s(e),style:{backgroundColor:"#5865f2",color:"white",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"12px"},children:"受諾"}),(0,n.jsx)("button",{onClick:()=>a(e.id),style:{backgroundColor:"#ed4245",color:"white",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"12px"},children:"拒否"})]})]},e.id))]})}function Q(e){let{server:t,currentUser:r,onClose:i}=e,[s,a]=(0,o.useState)([]),[c,p]=(0,o.useState)(!1),[x,u]=(0,o.useState)(null),[f,g]=(0,o.useState)({name:"",color:"#99aab5",permissions:[],position:1});C.ADMINISTRATOR,C.MANAGE_SERVER,C.MANAGE_ROLES,C.MANAGE_CHANNELS,C.SEND_MESSAGES,C.EDIT_DELETE_MESSAGES,C.PIN_MESSAGES,C.EMBED_LINKS,C.ATTACH_FILES,C.MENTION_EVERYONE,C.USE_EXTERNAL_EMOJIS,C.VIEW_MEMBERS,C.ADD_FRIENDS,C.MANAGE_MEMBERS,C.ASSIGN_ROLES,(0,o.useEffect)(()=>{if(!t)return;let e=((e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"serverRoles"),(0,d._M)("serverId","==",e),(0,d.My)("position","asc"));return(0,d.aQ)(r,t)})(t.id,e=>{a(e.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>t.position-e.position))});return()=>e()},[t]);let b=async()=>{if(f.name.trim())try{await W(t.id,{...f,canBeDeleted:!0,isDefault:!1}),p(!1),g({name:"",color:"#99aab5",permissions:[],position:1})}catch(e){console.error("ロール作成エラー:",e),alert("ロール作成に失敗しました")}},h=async(e,t)=>{try{await L(e,t),u(null)}catch(e){console.error("ロール更新エラー:",e),alert("ロール更新に失敗しました")}},y=async(e,t)=>{if(!t)return void alert("このロールは削除できません");if(confirm("このロールを削除しますか？"))try{await H(e)}catch(e){console.error("ロール削除エラー:",e),alert("ロール削除に失敗しました")}},m=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t&&x){let t=x.permissions.includes(e)?x.permissions.filter(t=>t!==e):[...x.permissions,e];u({...x,permissions:t})}else{let t=f.permissions.includes(e)?f.permissions.filter(t=>t!==e):[...f.permissions,e];g({...f,permissions:t})}},S=e=>({[C.ADMINISTRATOR]:"管理者",[C.MANAGE_SERVER]:"サーバー管理",[C.MANAGE_ROLES]:"ロール管理",[C.MANAGE_CHANNELS]:"チャンネル管理",[C.SEND_MESSAGES]:"メッセージ送信",[C.EDIT_DELETE_MESSAGES]:"メッセージ編集・削除",[C.PIN_MESSAGES]:"メッセージのピン留め",[C.EMBED_LINKS]:"埋め込みリンクの送信",[C.ATTACH_FILES]:"ファイル添付",[C.MENTION_EVERYONE]:"メンション許可",[C.USE_EXTERNAL_EMOJIS]:"外部絵文字使用",[C.VIEW_MEMBERS]:"メンバーの表示・検索",[C.ADD_FRIENDS]:"フレンド追加",[C.MANAGE_MEMBERS]:"メンバーのミュート/キック/バン",[C.ASSIGN_ROLES]:"ロール付与・削除"})[e]||e;return(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"800px",maxWidth:"90vw",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[(0,n.jsxs)("h2",{style:{color:"#ffffff",fontSize:"20px",fontWeight:"600",margin:0},children:["ロール管理 - ",null==t?void 0:t.name]}),(0,n.jsxs)("div",{style:{display:"flex",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>p(!0),style:{backgroundColor:"#5865f2",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"新しいロール"}),(0,n.jsx)("button",{onClick:i,style:{background:"none",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"18px"},children:"✕"})]})]}),(0,n.jsx)("div",{style:{flex:1,overflowY:"auto"},children:s.map(e=>{var t;return(0,n.jsxs)("div",{style:{backgroundColor:"#2f3136",borderRadius:"4px",padding:"16px",marginBottom:"12px"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[(0,n.jsx)("div",{style:{width:"20px",height:"20px",backgroundColor:e.color,borderRadius:"50%"}}),(0,n.jsx)("span",{style:{color:"#ffffff",fontSize:"16px",fontWeight:"600"},children:e.name})]}),e.canBeDeleted&&(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,n.jsx)("button",{onClick:()=>u(e),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",padding:"6px 12px",borderRadius:"4px",cursor:"pointer",fontSize:"12px"},children:"編集"}),(0,n.jsx)("button",{onClick:()=>y(e.id,e.canBeDeleted),style:{backgroundColor:"#ed4245",color:"white",border:"none",padding:"6px 12px",borderRadius:"4px",cursor:"pointer",fontSize:"12px"},children:"削除"})]})]}),(0,n.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px"},children:null==(t=e.permissions)?void 0:t.map(e=>(0,n.jsx)("span",{style:{backgroundColor:"#5865f2",color:"white",padding:"4px 8px",borderRadius:"12px",fontSize:"12px"},children:S(e)},e))})]},e.id)})}),c&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"600px",maxWidth:"90vw",maxHeight:"80vh",overflow:"auto"},children:[(0,n.jsx)("h3",{style:{color:"#ffffff",marginBottom:"16px"},children:"新しいロール"}),(0,n.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"4px",display:"block"},children:"ロール名"}),(0,n.jsx)("input",{type:"text",value:f.name,onChange:e=>g({...f,name:e.target.value}),style:{width:"100%",padding:"8px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"14px",boxSizing:"border-box"}})]}),(0,n.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"4px",display:"block"},children:"色"}),(0,n.jsx)("input",{type:"color",value:f.color,onChange:e=>g({...f,color:e.target.value}),style:{width:"50px",height:"30px",border:"none",borderRadius:"4px",cursor:"pointer"}})]}),(0,n.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"8px",display:"block"},children:"権限"}),(0,n.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(200px, 1fr))",gap:"8px"},children:Object.values(C).map(e=>(0,n.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#dcddde",fontSize:"12px",cursor:"pointer"},children:[(0,n.jsx)("input",{type:"checkbox",checked:f.permissions.includes(e),onChange:()=>m(e)}),S(e)]},e))})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>p(!1),style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:b,style:{backgroundColor:"#5865f2",border:"none",color:"white",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"作成"})]})]})}),x&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1100},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"600px",maxWidth:"90vw",maxHeight:"80vh",overflow:"auto"},children:[(0,n.jsx)("h3",{style:{color:"#ffffff",marginBottom:"16px"},children:"ロール編集"}),(0,n.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"4px",display:"block"},children:"ロール名"}),(0,n.jsx)("input",{type:"text",value:x.name,onChange:e=>u({...x,name:e.target.value}),style:{width:"100%",padding:"8px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"14px",boxSizing:"border-box"}})]}),(0,n.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"4px",display:"block"},children:"色"}),(0,n.jsx)("input",{type:"color",value:x.color,onChange:e=>u({...x,color:e.target.value}),style:{width:"50px",height:"30px",border:"none",borderRadius:"4px",cursor:"pointer"}})]}),(0,n.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,n.jsx)("label",{style:{color:"#b9bbbe",fontSize:"14px",marginBottom:"8px",display:"block"},children:"権限"}),(0,n.jsx)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(200px, 1fr))",gap:"8px"},children:Object.values(C).map(e=>{var t;return(0,n.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#dcddde",fontSize:"12px",cursor:"pointer"},children:[(0,n.jsx)("input",{type:"checkbox",checked:(null==(t=x.permissions)?void 0:t.includes(e))||!1,onChange:()=>m(e,!0)}),S(e)]},e)})})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>u(null),style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:()=>h(x.id,x),style:{backgroundColor:"#5865f2",border:"none",color:"white",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"保存"})]})]})})]})})}Object.values(V),V.MANAGE_SERVER,V.MANAGE_ROLES,V.MANAGE_CHANNELS,V.SEND_MESSAGES,V.EDIT_DELETE_MESSAGES,V.PIN_MESSAGES,V.EMBED_LINKS,V.ATTACH_FILES,V.MENTION_EVERYONE,V.USE_EXTERNAL_EMOJIS,V.VIEW_MEMBERS,V.MANAGE_MEMBERS,V.ASSIGN_ROLES,V.SEND_MESSAGES,V.EDIT_DELETE_MESSAGES,V.PIN_MESSAGES,V.EMBED_LINKS,V.ATTACH_FILES,V.VIEW_MEMBERS,V.MANAGE_MEMBERS,V.SEND_MESSAGES,V.EMBED_LINKS,V.ATTACH_FILES,V.VIEW_MEMBERS,V.ADD_FRIENDS;var X=r(2692);function q(e){let{channel:t,currentUser:r,isActive:i,onParticipantsUpdate:l,onSpeakingUsersUpdate:s,onMuteStateUpdate:d}=e,[a,c]=(0,o.useState)(!1),[p,x]=(0,o.useState)(!1),[u,f]=(0,o.useState)(!1),[g,b]=(0,o.useState)([]),[h,y]=(0,o.useState)(!1),[m,S]=(0,o.useState)(new Set),[v,j]=(0,o.useState)(0),C=(0,o.useRef)(null),E=(0,o.useRef)(null),w=(0,o.useRef)({}),k=(0,o.useRef)(null),I=(0,o.useRef)(null),R=(0,o.useRef)(null),D=(0,o.useRef)(null),M=(0,o.useRef)(null),_=(0,o.useRef)(null);(0,o.useEffect)(()=>{if(console.log("VoiceChannel useEffect:",{isActive:i,channelId:null==t?void 0:t.id,channelType:null==t?void 0:t.type}),!i||!t||"voice"!==t.type){(a||h)&&(console.log("チャンネル非アクティブ - クリーンアップ実行"),T());return}return console.log("ボイスチャンネル初期化開始"),A(),()=>{console.log("VoiceChannel useEffect cleanup"),T()}},[i,null==t?void 0:t.id,null==t?void 0:t.type]);let A=async()=>{try{y(!0),C.current=(0,X.Ay)("http://localhost:3001");let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});E.current=e,k.current&&(k.current.srcObject=e),L(e),z(),C.current.emit("join-voice-channel",{channelId:t.id,userId:r.uid,userName:r.displayName||"匿名"}),c(!0),y(!1)}catch(e){console.error("ボイスチャンネル初期化エラー:",e),y(!1),alert("マイクへのアクセスが拒否されました。ブラウザの設定を確認してください。")}},z=()=>{let e=C.current;e.on("user-joined-voice",async e=>{console.log("新しいユーザーが参加:",e),b(t=>[...t,e]),await N(e.userId,e.userName)}),e.on("user-left-voice",e=>{console.log("ユーザーが退出:",e),b(t=>t.filter(t=>t.userId!==e.userId)),w.current[e.userId]&&(w.current[e.userId].close(),delete w.current[e.userId])}),e.on("voice-participants",e=>{console.log("参加者リスト:",e);let n=e.filter(e=>e.userId!==r.uid);b(n),l&&l([{userId:r.uid,userName:r.displayName||"匿名",channelId:t.id},...n.map(e=>({...e,channelId:t.id}))])}),e.on("offer",async e=>{console.log("オファー受信:",e),await B(e)}),e.on("answer",async e=>{console.log("アンサー受信:",e),await G(e)}),e.on("ice-candidate",async e=>{console.log("ICE候補受信:",e),await O(e)}),e.on("user-speaking-update",e=>{console.log("ユーザー喋り状態更新:",e),e.isSpeaking?S(t=>{let r=new Set([...t,e.userId]);return s&&s(r),r}):S(t=>{let r=new Set(t);return r.delete(e.userId),s&&s(r),r})})},N=async(e,t)=>{try{let n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});E.current.getTracks().forEach(e=>{n.addTrack(e,E.current)}),n.onicecandidate=t=>{t.candidate&&C.current.emit("ice-candidate",{candidate:t.candidate,to:e,from:r.uid})},n.ontrack=e=>{console.log("リモートストリーム受信:",t),I.current&&(I.current.srcObject=e.streams[0])},w.current[e]=n;let o=await n.createOffer();await n.setLocalDescription(o),C.current.emit("offer",{offer:o,to:e,from:r.uid})}catch(e){console.error("ピア接続作成エラー:",e)}},B=async e=>{try{let t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});E.current.getTracks().forEach(e=>{t.addTrack(e,E.current)}),t.onicecandidate=t=>{t.candidate&&C.current.emit("ice-candidate",{candidate:t.candidate,to:e.from,from:r.uid})},t.ontrack=e=>{console.log("リモートストリーム受信"),I.current&&(I.current.srcObject=e.streams[0])},w.current[e.from]=t,await t.setRemoteDescription(e.offer);let n=await t.createAnswer();await t.setLocalDescription(n),C.current.emit("answer",{answer:n,to:e.from,from:r.uid})}catch(e){console.error("オファー処理エラー:",e)}},G=async e=>{try{let t=w.current[e.from];t&&await t.setRemoteDescription(e.answer)}catch(e){console.error("アンサー処理エラー:",e)}},O=async e=>{try{let t=w.current[e.from];t&&await t.addIceCandidate(e.candidate)}catch(e){console.error("ICE候補処理エラー:",e)}},T=()=>{console.log("ボイスチャンネルクリーンアップ開始"),P(),E.current&&(E.current.getTracks().forEach(e=>{e.stop(),console.log("オーディオトラック停止:",e.id)}),E.current=null),Object.entries(w.current).forEach(e=>{let[t,r]=e;console.log("ピア接続を閉じる:",t),r.close()}),w.current={},C.current&&(console.log("Socket.IO接続を閉じる"),C.current.emit("leave-voice-channel",{channelId:null==t?void 0:t.id,userId:r.uid}),C.current.disconnect(),C.current=null),c(!1),y(!1),b([]),S(new Set),j(0),l&&l([]),s&&s(new Set),console.log("ボイスチャンネルクリーンアップ完了")},W=()=>{if(E.current){let e=E.current.getAudioTracks()[0];if(e){e.enabled=!e.enabled;let t=!e.enabled;x(t),d&&d(t)}}},L=e=>{try{R.current=new(window.AudioContext||window.webkitAudioContext),D.current=R.current.createAnalyser(),D.current.fftSize=256,D.current.smoothingTimeConstant=.8,M.current=R.current.createMediaStreamSource(e),M.current.connect(D.current),H()}catch(e){console.error("音声レベル検出初期化エラー:",e)}},H=()=>{let e=D.current;if(!e)return;let n=new Uint8Array(e.frequencyBinCount),o=()=>{var i,l;e.getByteFrequencyData(n);let s=0;for(let e=0;e<n.length;e++)s+=n[e];let d=s/n.length/255;j(d);let a=d>.1;a&&!m.has(r.uid)?(S(e=>new Set([...e,r.uid])),null==(i=C.current)||i.emit("user-speaking",{channelId:t.id,userId:r.uid,isSpeaking:!0})):!a&&m.has(r.uid)&&(S(e=>{let t=new Set(e);return t.delete(r.uid),t}),null==(l=C.current)||l.emit("user-speaking",{channelId:t.id,userId:r.uid,isSpeaking:!1})),_.current=requestAnimationFrame(o)};o()},P=()=>{_.current&&(cancelAnimationFrame(_.current),_.current=null),M.current&&(M.current.disconnect(),M.current=null),D.current&&(D.current=null),R.current&&(R.current.close(),R.current=null)};return i&&(null==t?void 0:t.type)==="voice"?(0,n.jsxs)("div",{style:{position:"fixed",bottom:"20px",left:"280px",backgroundColor:"#2f3136",borderRadius:"8px",padding:"12px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)",zIndex:1e3,minWidth:"280px",maxWidth:"320px"},children:[(0,n.jsx)("style",{children:"\n                @keyframes pulse {\n                    0% { opacity: 1; transform: scale(1); }\n                    50% { opacity: 0.5; transform: scale(1.2); }\n                    100% { opacity: 1; transform: scale(1); }\n                }\n            "}),(0,n.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px",padding:"8px 12px",backgroundColor:"#40444b",borderRadius:"6px"},children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("span",{style:{color:"#43b581",fontSize:"14px"},children:"●"}),(0,n.jsx)("span",{style:{color:"white",fontSize:"14px",fontWeight:"500"},children:"通話中"}),(0,n.jsx)("span",{style:{color:"#b9bbbe",fontSize:"12px"},children:t.name})]})}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"12px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("button",{style:{backgroundColor:"transparent",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"16px",padding:"8px",borderRadius:"4px"},title:"ビデオ",children:"\uD83D\uDCF9"}),(0,n.jsx)("button",{style:{backgroundColor:"transparent",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"16px",padding:"8px",borderRadius:"4px"},title:"画面共有",children:"\uD83D\uDDA5️"}),(0,n.jsx)("button",{style:{backgroundColor:"transparent",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"16px",padding:"8px",borderRadius:"4px"},title:"アクティビティ",children:"\uD83C\uDFAE"}),(0,n.jsx)("button",{style:{backgroundColor:"transparent",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"16px",padding:"8px",borderRadius:"4px"},title:"アクティビティ",children:"\uD83D\uDCA1"})]}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"end",gap:"2px",height:"20px"},children:[(0,n.jsx)("div",{style:{width:"3px",height:"8px",backgroundColor:"#43b581",borderRadius:"1px"}}),(0,n.jsx)("div",{style:{width:"3px",height:"12px",backgroundColor:"#43b581",borderRadius:"1px"}}),(0,n.jsx)("div",{style:{width:"3px",height:"16px",backgroundColor:"#43b581",borderRadius:"1px"}})]}),(0,n.jsx)("button",{onClick:T,style:{backgroundColor:"#f04747",border:"none",color:"white",cursor:"pointer",fontSize:"16px",padding:"8px",borderRadius:"50%",width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center"},title:"退出",children:"\uD83D\uDCDE"})]})]}),m.size>0&&(0,n.jsx)("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px",backgroundColor:"#40444b",borderRadius:"6px"},children:Array.from(m).slice(0,1).map(e=>{let t=g.find(t=>t.userId===e)||(e===r.uid?{userName:r.displayName||"匿名"}:null);return t?(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsxs)("div",{style:{width:"24px",height:"24px",borderRadius:"50%",backgroundColor:e===r.uid?"#5865f2":"#43b581",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"12px",fontWeight:"600",position:"relative"},children:[t.userName.charAt(0).toUpperCase(),(0,n.jsx)("div",{style:{position:"absolute",bottom:"-2px",right:"-2px",width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#43b581",border:"1px solid #40444b",animation:"pulse 1.5s infinite"}})]}),(0,n.jsx)("span",{style:{color:"white",fontSize:"12px"},children:t.userName}),(0,n.jsx)("span",{style:{color:"#43b581",fontSize:"10px"},children:"会話中"}),(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px",marginLeft:"auto"},children:[(0,n.jsx)("button",{onClick:W,style:{background:"none",border:"none",color:p?"#f04747":"#43b581",cursor:"pointer",fontSize:"12px",padding:"2px"},title:p?"ミュート解除":"ミュート",children:p?"\uD83D\uDD07":"\uD83C\uDFA4"}),(0,n.jsx)("span",{style:{color:"#b9bbbe",fontSize:"12px"},children:"⚙️"})]})]},e):null})}),(0,n.jsx)("audio",{ref:k,autoPlay:!0,muted:!0}),(0,n.jsx)("audio",{ref:I,autoPlay:!0,muted:u})]}):null}function $(e){let{user:t,currentServer:r}=e,[i,l]=(0,o.useState)([]),[s,d]=(0,o.useState)([]),[a,p]=(0,o.useState)(""),[x,u]=(0,o.useState)(""),[f,g]=(0,o.useState)([]),[b,h]=(0,o.useState)(!1),[y,m]=(0,o.useState)(!1),[S,v]=(0,o.useState)("");(0,o.useEffect)(()=>{t&&(async()=>{try{let e=await c(t.uid);l(e.tags||[])}catch(e){console.error("ユーザータグ取得エラー:",e)}})()},[t]),(0,o.useEffect)(()=>{(async()=>{try{let e=await z();d(e)}catch(e){console.error("タグ取得エラー:",e)}})()},[]);let j=async()=>{if(!(!a.trim()||i.includes(a.trim())))try{let e=[...i,a.trim()];await _(t.uid,e),l(e),p("")}catch(e){console.error("タグ追加エラー:",e),alert("タグの追加に失敗しました")}},C=async e=>{try{let r=i.filter(t=>t!==e);await _(t.uid,r),l(r)}catch(e){console.error("タグ削除エラー:",e),alert("タグの削除に失敗しました")}},E=async()=>{if(x.trim()){h(!0);try{let e=await A(x.trim());g(e)}catch(e){console.error("タグ検索エラー:",e),alert("ユーザーの検索に失敗しました")}finally{h(!1)}}},w=async()=>{if(S.trim()&&r){h(!0);try{await I(r.id,S.trim(),t.displayName||"匿名"),alert('タグ "'.concat(S,'" のユーザーを招待しました')),v(""),m(!1)}catch(e){console.error("タグ別招待エラー:",e),alert("招待に失敗しました: ".concat(e.message))}finally{h(!1)}}};return(0,n.jsxs)("div",{style:{backgroundColor:"#2f3136",borderRadius:"8px",padding:"16px",color:"#dcddde",maxWidth:"400px"},children:[(0,n.jsx)("h3",{style:{margin:"0 0 16px 0",fontSize:"16px",fontWeight:"600"},children:"タグ管理"}),(0,n.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,n.jsx)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"500"},children:"あなたのタグ"}),(0,n.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px",marginBottom:"12px"},children:i.map((e,t)=>(0,n.jsxs)("div",{style:{backgroundColor:"#5865f2",color:"white",borderRadius:"12px",padding:"4px 8px",fontSize:"12px",display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsxs)("span",{children:["#",e]}),(0,n.jsx)("button",{onClick:()=>C(e),style:{background:"none",border:"none",color:"white",cursor:"pointer",fontSize:"12px",padding:"0",marginLeft:"4px"},children:"\xd7"})]},t))}),(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,n.jsx)("input",{type:"text",value:a,onChange:e=>p(e.target.value),placeholder:"新しいタグを追加",style:{flex:1,padding:"8px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"14px"}}),(0,n.jsx)("button",{onClick:j,disabled:!a.trim(),style:{backgroundColor:a.trim()?"#5865f2":"#4f545c",color:"white",border:"none",borderRadius:"4px",padding:"8px 12px",cursor:a.trim()?"pointer":"not-allowed",fontSize:"14px"},children:"追加"})]})]}),(0,n.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,n.jsx)("h4",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"500"},children:"タグでユーザーを検索"}),(0,n.jsxs)("div",{style:{display:"flex",gap:"8px",marginBottom:"12px"},children:[(0,n.jsx)("input",{type:"text",value:x,onChange:e=>u(e.target.value),placeholder:"タグを入力",style:{flex:1,padding:"8px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"14px"}}),(0,n.jsx)("button",{onClick:E,disabled:!x.trim()||b,style:{backgroundColor:x.trim()&&!b?"#5865f2":"#4f545c",color:"white",border:"none",borderRadius:"4px",padding:"8px 12px",cursor:x.trim()&&!b?"pointer":"not-allowed",fontSize:"14px"},children:b?"検索中...":"検索"})]}),f.length>0&&(0,n.jsx)("div",{style:{backgroundColor:"#40444b",borderRadius:"4px",padding:"8px",maxHeight:"150px",overflowY:"auto"},children:f.map(e=>(0,n.jsxs)("div",{style:{padding:"8px",borderBottom:"1px solid #36393f",display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("div",{style:{width:"24px",height:"24px",borderRadius:"50%",backgroundColor:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"12px",fontWeight:"600"},children:(e.displayName||"匿").charAt(0).toUpperCase()}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{style:{fontSize:"14px"},children:e.displayName||"匿名"}),(0,n.jsx)("div",{style:{fontSize:"12px",color:"#b9bbbe"},children:e.email})]})]},e.id))})]}),r&&(0,n.jsx)("div",{children:(0,n.jsx)("button",{onClick:()=>m(!0),style:{backgroundColor:"#3ba55c",color:"white",border:"none",borderRadius:"4px",padding:"8px 12px",cursor:"pointer",fontSize:"14px",width:"100%"},children:"タグでユーザーを招待"})}),y&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"400px",maxWidth:"90vw"},children:[(0,n.jsx)("h3",{style:{color:"#ffffff",fontSize:"18px",fontWeight:"600",margin:"0 0 16px 0"},children:"タグでユーザーを招待"}),(0,n.jsxs)("div",{style:{marginBottom:"16px"},children:[(0,n.jsx)("label",{style:{display:"block",color:"#b9bbbe",fontSize:"12px",fontWeight:"600",marginBottom:"8px"},children:"招待するタグ"}),(0,n.jsx)("input",{type:"text",value:S,onChange:e=>v(e.target.value),placeholder:"#社長 #メンバー",style:{width:"100%",padding:"12px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"16px",marginBottom:"8px"}}),(0,n.jsx)("div",{style:{color:"#b9bbbe",fontSize:"12px"},children:"例: #社長 や #メンバー などのタグを入力"})]}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>{m(!1),v("")},style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:w,disabled:!S.trim()||b,style:{backgroundColor:S.trim()&&!b?"#3ba55c":"#4f545c",border:"none",color:"white",padding:"10px 16px",borderRadius:"4px",cursor:S.trim()&&!b?"pointer":"not-allowed",fontSize:"14px"},children:b?"招待中...":"招待"})]})]})})]})}function ee(){let[e,t]=(0,o.useState)(null),[r,c]=(0,o.useState)([]),[y,m]=(0,o.useState)(null),[j,E]=(0,o.useState)([]),[w,I]=(0,o.useState)(null),[R,D]=(0,o.useState)([]),[_,A]=(0,o.useState)(""),[z,N]=(0,o.useState)(null),[B,W]=(0,o.useState)(null),[L,H]=(0,o.useState)([]),[V,K]=(0,o.useState)(!1),[X,ee]=(0,o.useState)(!1),[er,en]=(0,o.useState)(!1),[eo,ei]=(0,o.useState)(!1),[el,es]=(0,o.useState)(!1),[ed,ea]=(0,o.useState)(""),[ec,ep]=(0,o.useState)([]),[ex,eu]=(0,o.useState)(null),[ef,eg]=(0,o.useState)(null),[eb,eh]=(0,o.useState)(!1),[ey,em]=(0,o.useState)([]),[eS,ev]=(0,o.useState)(new Set),[ej,eC]=(0,o.useState)(!1),[eE,ew]=(0,o.useState)(!1),ek=(0,o.useRef)(null),eI=(0,s.useRouter)();(0,o.useEffect)(()=>{let e=(0,i.hg)(l.j,async e=>{if(e){console.log("ユーザー認証成功:",e.uid,e.email),t(e);try{await M(e.uid,{displayName:e.displayName||"匿名",email:e.email,photoURL:e.photoURL}),console.log("ユーザー情報保存完了")}catch(e){console.error("ユーザー情報保存エラー:",e)}}else console.log("ユーザー未認証 - ログインページへリダイレクト"),eI.push("/login")});return()=>e()},[eI]),(0,o.useEffect)(()=>{if(!e)return;console.log("サーバー取得開始 - ユーザーID:",e.uid);let t=((e,t,r)=>{console.log("getUserServers 呼び出し - ユーザーID:",e);let n=(0,d.P)((0,d.rJ)(l.db,"servers"),(0,d._M)("members","array-contains",e));return console.log("Firestore クエリ作成完了"),(0,d.aQ)(n,t,r)})(e.uid,e=>{console.log("サーバー取得結果:",e.docs.length,"件");let t=e.docs.map(e=>{let t=e.data();return console.log("サーバーデータ:",e.id,t),{id:e.id,...t}});c(t),console.log("設定されたサーバーリスト:",t),y||eE||(0===t.length?(console.log("サーバーが見つかりませんでした - DMモードに切り替え"),ew(!0),m({id:"dm",name:"ダイレクトメッセージ"})):(console.log("最初のサーバーを選択:",t[0]),m(t[0])))},e=>{console.error("サーバー取得エラー:",e)});return()=>t()},[e,y,eE]),(0,o.useEffect)(()=>{if(!e)return;let t=((e,t,r)=>{try{let n=(0,d.rJ)(l.db,"channels"),o=(0,d.P)(n,(0,d._M)("type","==","dm"),(0,d._M)("participants","array-contains",e),(0,d.My)("lastMessageAt","desc"));return(0,d.aQ)(o,t,r)}catch(i){console.error("DM取得エラー:",i);let n=(0,d.rJ)(l.db,"channels"),o=(0,d.P)(n,(0,d._M)("type","==","dm"),(0,d._M)("participants","array-contains",e),(0,d.My)("createdAt","desc"));return(0,d.aQ)(o,t,r)}})(e.uid,e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));H(t),console.log("DM一覧取得:",t)});return()=>t()},[e]),(0,o.useEffect)(()=>{if(!y||"dm"===y.id)return void E([]);let e=((e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"channels"),(0,d._M)("serverId","==",e));return(0,d.aQ)(r,t)})(y.id,e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));E(t),t.length>0&&!w&&I(t[0])});return()=>e()},[y]),(0,o.useEffect)(()=>{if(!w)return;let e=((e,t)=>{let r=(0,d.P)((0,d.rJ)(l.db,"messages"),(0,d._M)("channelId","==",e));return(0,d.aQ)(r,t)})(w.id,e=>{D(e.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>e.timestamp&&t.timestamp?(e.timestamp.seconds||0)-(t.timestamp.seconds||0):0)),eR()});return()=>e()},[w]),(0,o.useEffect)(()=>{if(!e||!y||"dm"===y.id)return void ep([]);(async()=>{try{let t=await S(y.id,e.uid);ep(t)}catch(e){console.error("権限取得エラー:",e),ep([])}})()},[e,y]);let eR=()=>{var e;null==(e=ek.current)||e.scrollIntoView({behavior:"smooth"})},eD=t=>{var r;if(!t||"dm"!==t.type)return"";let n=t&&"dm"===t.type?t.participants.find(t=>t!==e.uid):null;return(null==(r=t.participantNames)?void 0:r[n])||"不明なユーザー"},eM=e=>{console.log("サーバー選択:",e),w&&"voice"===w.type&&(console.log("サーバー変更時のボイスチャンネル非アクティブ化"),eh(!1)),"dm"===e?(m({id:"dm",name:"ダイレクトメッセージ"}),E([]),I(null),D([]),ew(!0)):(m(r.find(t=>t.id===e)),I(null),D([]),ew(!1))},e_=async()=>{if((_.trim()||ex)&&e&&w){if((null==y?void 0:y.id)!=="dm"&&!v(ec,C.SEND_MESSAGES))return void alert("メッセージを送信する権限がありません");try{z?(await u(z.id,_.trim()),N(null)):("dm"===w.type?ex?await T(w.id,e.uid,e.displayName||"匿名",_.trim(),ex.id,null==B?void 0:B.id):await h(w.id,e.uid,e.displayName||"匿名",_.trim(),null==B?void 0:B.id):ex?await T(w.id,e.uid,e.displayName||"匿名",_.trim(),ex.id,null==B?void 0:B.id):await x(w.id,e.uid,e.displayName||"匿名",_.trim(),null==B?void 0:B.id),W(null)),A(""),eu(null)}catch(e){console.error("メッセージ送信エラー:",e),alert("メッセージの送信に失敗しました")}}},eA=async t=>{if(e)try{await a(t,e.uid,e.displayName||"匿名")}catch(e){console.error("サーバー作成エラー:",e),alert("サーバーの作成に失敗しました")}},ez=async t=>{if(e&&y&&"dm"!==y.id)try{await p(t.name,t.type,y.id,e.uid)}catch(e){console.error("チャンネル作成エラー:",e),alert("チャンネルの作成に失敗しました")}},eN=async()=>{try{await (0,i.CI)(l.j),eI.push("/login")}catch(e){console.error("ログアウトエラー:",e)}},eB=async(t,r)=>{if(e)try{var n,o;(null==(o=R.find(e=>e.id===t).reactions)||null==(n=o[r])?void 0:n.includes(e.uid))?await b(t,e.uid,r):await g(t,e.uid,r)}catch(e){console.error("リアクションエラー:",e)}},eG=async()=>{if(ed.trim()&&y&&"dm"!==y.id)try{await k(y.id,ed.trim(),e.displayName||"匿名"),ea(""),ee(!1),alert("招待を送信しました")}catch(e){console.error("招待エラー:",e),alert("招待に失敗しました: "+e.message)}},eO=async t=>{try{await O(t,e.uid),(null==y?void 0:y.id)===t&&eM("dm")}catch(e){console.error("サーバー削除エラー:",e),alert("サーバー削除に失敗しました: "+e.message)}},eT=async(e,t)=>{try{await G(e,t)}catch(e){console.error("アイコン更新エラー:",e),alert("アイコン更新に失敗しました")}},eW=e=>e?(e.toDate?e.toDate():new Date(e)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",eL=e=>{if(!e)return"";let t=e.toDate?e.toDate():new Date(e),r=new Date,n=new Date(r);return(n.setDate(n.getDate()-1),t.toDateString()===r.toDateString())?"今日":t.toDateString()===n.toDateString()?"昨日":t.toLocaleDateString()};return(0,n.jsxs)("div",{style:{display:"flex",height:"100vh",backgroundColor:"#36393f",color:"#dcddde",fontFamily:'"Helvetica Neue", Helvetica, Arial, sans-serif'},children:[(0,n.jsx)(J,{servers:r,currentServer:null==y?void 0:y.id,onServerSelect:eM,onCreateServer:eA,onDeleteServer:eO,onUpdateServerIcon:eT,currentUser:e}),eE||(null==y?void 0:y.id)==="dm"?(0,n.jsx)(F,{user:e,onDMChannelSelect:e=>{console.log("DMチャンネル選択:",e),I(e),m({id:"dm",name:"ダイレクトメッセージ"}),ew(!0)},currentChannel:w}):y?(0,n.jsx)(U,{server:y,channels:j,currentChannel:null==w?void 0:w.id,onChannelSelect:e=>{let t=j.find(t=>t.id===e);console.log("チャンネル選択:",null==t?void 0:t.name,null==t?void 0:t.type),w&&"voice"===w.type&&(console.log("現在のボイスチャンネルを非アクティブ化"),eh(!1)),I(t),t&&"voice"===t.type&&(console.log("新しいボイスチャンネルをアクティブ化"),eh(!0))},onCreateChannel:ez,user:e,voiceParticipants:ey,speakingUsers:eS,isMuted:ej}):null,(0,n.jsxs)("div",{style:{flex:1,display:"flex",flexDirection:"column",position:"relative"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 20px",backgroundColor:"#2f3136",borderBottom:"1px solid #202225"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:16},children:[(0,n.jsx)("h2",{style:{margin:0,fontSize:18,fontWeight:600,color:"#ffffff"},children:w?"dm"===w.type?"\uD83D\uDCAC ".concat(eD(w)):"voice"===w.type?"\uD83D\uDD0A ".concat(w.name):"# ".concat(w.name):eE?"フレンドを選択してください":"チャンネルを選択してください"}),y&&"dm"!==y.id&&(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,n.jsx)("button",{onClick:()=>K(!0),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"14px"},children:"\uD83D\uDC65 メンバー"}),(0,n.jsx)("button",{onClick:()=>ee(!0),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"14px"},children:"➕ 招待"}),v(ec,C.MANAGE_ROLES)&&(0,n.jsx)("button",{onClick:()=>en(!0),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"14px"},children:"\uD83C\uDFAD ロール"}),v(ec,C.MANAGE_MEMBERS)&&(0,n.jsx)("button",{onClick:()=>es(!0),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",padding:"6px 12px",cursor:"pointer",fontSize:"14px"},children:"\uD83C\uDFF7️ タグ"})]})]}),e&&(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12},children:[(0,n.jsxs)("button",{onClick:()=>eI.push("/mypage"),style:{background:"none",border:"none",color:"#b9bbbe",cursor:"pointer",padding:"8px",borderRadius:"4px"},children:["\uD83D\uDC64 ",e.displayName||"匿名"]}),(0,n.jsx)("button",{onClick:eN,style:{backgroundColor:"#5865f2",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:"pointer"},children:"ログアウト"})]})]}),w?"voice"===w.type?(0,n.jsxs)("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",backgroundColor:"#36393f",gap:"20px"},children:[(0,n.jsx)("div",{style:{fontSize:"64px",marginBottom:"20px"},children:"\uD83D\uDD0A"}),(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"32px",fontWeight:"600",margin:"0 0 16px 0"},children:w.name}),(0,n.jsx)("p",{style:{color:"#b9bbbe",fontSize:"16px",margin:"0 0 32px 0",textAlign:"center"},children:"ボイスチャンネルに接続されています"}),ey.length>0&&(0,n.jsx)("div",{style:{display:"flex",gap:"16px",flexWrap:"wrap",justifyContent:"center"},children:ey.map(e=>(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("div",{style:{width:"80px",height:"80px",borderRadius:"50%",backgroundColor:eS.has(e.id)?"#43b581":"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"32px",fontWeight:"600",border:eS.has(e.id)?"4px solid #43b581":"4px solid transparent",transition:"all 0.2s ease"},children:e.name.charAt(0).toUpperCase()}),(0,n.jsx)("span",{style:{color:"#ffffff",fontSize:"14px",fontWeight:"600"},children:e.name}),e.muted&&(0,n.jsx)("span",{style:{fontSize:"12px"},children:"\uD83D\uDD07"})]},e.id))})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{style:{flex:1,overflowY:"auto",padding:"20px"},children:[R.map((t,r)=>{var o;let i=R[r-1],l=!i||eL(t.timestamp)!==eL(i.timestamp),s=t.userId===e.uid,d=(null==w?void 0:w.type)==="dm",a=i&&i.userId===t.userId&&t.timestamp&&i.timestamp&&t.timestamp.toDate()-i.timestamp.toDate()<3e5;return(0,n.jsxs)("div",{children:[l&&(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",margin:"24px 16px 8px",gap:"12px"},children:[(0,n.jsx)("div",{style:{height:"1px",backgroundColor:"#40444b",flex:1}}),(0,n.jsx)("span",{style:{color:"#72767d",fontSize:"12px",fontWeight:"600",backgroundColor:"#36393f",padding:"2px 8px",borderRadius:"8px"},children:eL(t.timestamp)}),(0,n.jsx)("div",{style:{height:"1px",backgroundColor:"#40444b",flex:1}})]}),(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:d&&s?"flex-end":"flex-start",margin:a?"2px 16px":"8px 16px",position:"relative"},onMouseEnter:()=>eg(t.id),onMouseLeave:()=>eg(null),children:[(!d||!s&&!a)&&(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px",marginLeft:d&&s?"0":"12px"},children:[(0,n.jsx)("div",{style:{width:"24px",height:"24px",borderRadius:"50%",backgroundColor:"#5865f2",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontSize:"12px",fontWeight:"600"},children:(t.userName||"匿名").charAt(0).toUpperCase()}),(0,n.jsx)("span",{style:{fontWeight:"600",color:"#ffffff",fontSize:"14px"},children:t.userName||"匿名"}),(0,n.jsx)("span",{style:{fontSize:"11px",color:"#72767d"},children:eW(t.timestamp)})]}),(0,n.jsxs)("div",{style:{maxWidth:"70%",minWidth:"60px",position:"relative"},children:[t.replyTo&&(0,n.jsx)("div",{style:{backgroundColor:d&&s?"#4c5bdb":"#4f545c",padding:"6px 12px",borderRadius:"12px 12px 4px 4px",marginBottom:"2px",fontSize:"13px",color:"#dcddde",opacity:.8,borderLeft:d&&s?"3px solid #ffffff":"3px solid #5865f2"},children:(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,n.jsx)("span",{children:"↳"}),(0,n.jsx)("span",{style:{fontWeight:"600"},children:"返信:"}),(0,n.jsx)("span",{children:t.replyTo})]})}),(0,n.jsxs)("div",{style:{backgroundColor:d&&s?"#5865f2":"#40444b",color:d&&s?"#ffffff":"#dcddde",padding:"12px 16px",borderRadius:d&&s?"18px 18px 4px 18px":d?"18px 18px 18px 4px":"18px",fontSize:"15px",lineHeight:"1.375",wordWrap:"break-word",position:"relative",boxShadow:"0 1px 2px rgba(0,0,0,0.1)"},children:[t.content&&(0,n.jsx)("div",{style:{marginBottom:(null==(o=t.attachments)?void 0:o.length)?"8px":"0"},children:t.content}),t.attachments&&t.attachments.map((e,r)=>(0,n.jsx)("div",{style:{marginTop:t.content?"8px":"0"},children:"image"===e.type&&(0,n.jsx)("div",{style:{borderRadius:"12px",overflow:"hidden",maxWidth:"300px"},children:(0,n.jsx)(et,{imageId:e.id})})},r)),t.edited&&(0,n.jsx)("div",{style:{fontSize:"10px",color:d&&s?"rgba(255,255,255,0.7)":"#72767d",fontStyle:"italic",marginTop:"4px",textAlign:"right"},children:"編集済み"})]}),(d||a)&&(0,n.jsx)("div",{style:{fontSize:"11px",color:"#72767d",marginTop:"2px",textAlign:d&&s?"right":"left",paddingLeft:d&&s?"0":"12px",paddingRight:d&&s?"12px":"0"},children:eW(t.timestamp)}),t.reactions&&Object.keys(t.reactions).length>0&&(0,n.jsx)("div",{style:{display:"flex",gap:"4px",marginTop:"6px",flexWrap:"wrap",justifyContent:d&&s?"flex-end":"flex-start"},children:Object.entries(t.reactions).map(r=>{let[o,i]=r;return(0,n.jsxs)("button",{onClick:()=>eB(t.id,o),style:{backgroundColor:i.includes(e.uid)?d&&s?"#ffffff":"#5865f2":"rgba(64, 68, 75, 0.6)",color:i.includes(e.uid)?d&&s?"#5865f2":"#ffffff":"#dcddde",border:"none",borderRadius:"12px",padding:"2px 8px",fontSize:"12px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",transition:"all 0.1s ease",backdropFilter:"blur(10px)"},children:[(0,n.jsx)("span",{children:o}),(0,n.jsx)("span",{style:{fontSize:"10px",fontWeight:"600"},children:i.length})]},o)})})]}),ef===t.id&&(0,n.jsxs)("div",{style:{position:"absolute",top:"-8px",[d&&s?"left":"right"]:"20px",display:"flex",gap:"2px",backgroundColor:"#2f3136",padding:"4px",borderRadius:"8px",border:"1px solid #40444b",boxShadow:"0 2px 8px rgba(0,0,0,0.2)",zIndex:10},children:[(0,n.jsx)("button",{onClick:()=>W(t),style:{backgroundColor:"transparent",border:"none",borderRadius:"4px",padding:"6px",color:"#b9bbbe",cursor:"pointer",fontSize:"14px"},title:"返信",children:"\uD83D\uDCAC"}),t.userId===e.uid&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:()=>{N(t),A(t.content)},style:{backgroundColor:"transparent",border:"none",borderRadius:"4px",padding:"6px",color:"#b9bbbe",cursor:"pointer",fontSize:"14px"},title:"編集",children:"✏️"}),(0,n.jsx)("button",{onClick:()=>f(t.id),style:{backgroundColor:"transparent",border:"none",borderRadius:"4px",padding:"6px",color:"#b9bbbe",cursor:"pointer",fontSize:"14px"},title:"削除",children:"\uD83D\uDDD1️"})]}),(0,n.jsx)("button",{onClick:()=>eB(t.id,"\uD83D\uDC4D"),style:{backgroundColor:"transparent",border:"none",borderRadius:"4px",padding:"6px",color:"#b9bbbe",cursor:"pointer",fontSize:"14px"},title:"いいね",children:"\uD83D\uDC4D"})]})]})]},t.id)}),(0,n.jsx)("div",{ref:ek})]}),(0,n.jsxs)("div",{style:{padding:"20px",backgroundColor:"#36393f",borderTop:"1px solid #40444b"},children:[(z||B)&&(0,n.jsxs)("div",{style:{backgroundColor:"#2f3136",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsx)("span",{style:{color:"#dcddde",fontSize:"14px"},children:z?"編集中...":(null==w?void 0:w.type)==="dm"?"".concat(eD(w),"に返信中..."):"".concat(B.userName,"に返信中...")}),(0,n.jsx)("button",{onClick:()=>{N(null),W(null),A("")},style:{background:"none",border:"none",color:"#72767d",cursor:"pointer"},children:"✕"})]}),ex&&(0,n.jsxs)("div",{style:{backgroundColor:"#2f3136",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,n.jsx)("img",{src:ex.url,alt:"添付画像",style:{width:"40px",height:"40px",objectFit:"cover",borderRadius:"4px"}}),(0,n.jsx)("span",{style:{color:"#dcddde",fontSize:"14px"},children:ex.name})]}),(0,n.jsx)("button",{onClick:()=>eu(null),style:{background:"none",border:"none",color:"#72767d",cursor:"pointer"},children:"✕"})]}),(0,n.jsxs)("div",{style:{backgroundColor:"#40444b",borderRadius:"8px",padding:"12px",display:"flex",alignItems:"flex-end",gap:"12px"},children:[(0,n.jsx)("textarea",{value:_,onChange:e=>A(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e_())},placeholder:(null==w?void 0:w.type)==="dm"?"".concat(eD(w),"にメッセージを送信"):"#".concat(w.name," にメッセージを送信"),style:{flex:1,backgroundColor:"transparent",border:"none",color:"#dcddde",fontSize:"16px",resize:"none",outline:"none",fontFamily:"inherit",lineHeight:"1.375",minHeight:"24px",maxHeight:"120px"},rows:1}),((null==y?void 0:y.id)!=="dm"&&v(ec,C.ATTACH_FILES)||(null==w?void 0:w.type)==="dm")&&(0,n.jsx)("button",{onClick:()=>ei(!0),style:{backgroundColor:"#40444b",color:"#dcddde",border:"none",borderRadius:"4px",width:"32px",height:"32px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"16px"},children:"\uD83D\uDCCE"}),(0,n.jsx)("button",{onClick:e_,disabled:!_.trim()&&!ex,style:{backgroundColor:_.trim()||ex?"#5865f2":"#4f545c",color:"white",border:"none",borderRadius:"4px",width:"32px",height:"32px",cursor:_.trim()||ex?"pointer":"not-allowed",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"16px"},children:"➤"})]})]})]}):(0,n.jsxs)("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",backgroundColor:"#36393f",gap:"20px"},children:[(0,n.jsx)("div",{style:{fontSize:"64px",marginBottom:"20px"},children:"\uD83D\uDCAC"}),(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"24px",fontWeight:"600",margin:"0"},children:eE?"フレンドを選択してください":"チャンネルを選択してください"}),(0,n.jsx)("p",{style:{color:"#b9bbbe",fontSize:"16px",margin:"0",textAlign:"center"},children:eE?"左側のフレンドリストからチャットを開始するフレンドを選択してください。":"左側のチャンネルリストからチャンネルを選択してください。"})]}),V&&y&&"dm"!==y.id&&(0,n.jsx)(Y,{server:y,currentUser:e,onClose:()=>K(!1)}),el&&y&&"dm"!==y.id&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"500px",maxWidth:"90vw"},children:[(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[(0,n.jsx)("h3",{style:{color:"#ffffff",fontSize:"18px",fontWeight:"600",margin:0},children:"タグ管理"}),(0,n.jsx)("button",{onClick:()=>es(!1),style:{background:"none",border:"none",color:"#b9bbbe",cursor:"pointer",fontSize:"16px",padding:"4px"},children:"\xd7"})]}),(0,n.jsx)($,{user:e,currentServer:y})]})}),X&&y&&"dm"!==y.id&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.85)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:(0,n.jsxs)("div",{style:{backgroundColor:"#36393f",borderRadius:"8px",padding:"24px",width:"400px",maxWidth:"90vw"},children:[(0,n.jsx)("h2",{style:{color:"#ffffff",fontSize:"20px",fontWeight:"600",margin:"0 0 16px 0"},children:"ユーザーを招待"}),(0,n.jsx)("input",{type:"email",value:ed,onChange:e=>ea(e.target.value),placeholder:"メールアドレス",style:{width:"100%",padding:"12px",backgroundColor:"#40444b",border:"none",borderRadius:"4px",color:"#dcddde",fontSize:"16px",marginBottom:"16px",boxSizing:"border-box"}}),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"12px"},children:[(0,n.jsx)("button",{onClick:()=>{ee(!1),ea("")},style:{backgroundColor:"transparent",border:"none",color:"#ffffff",padding:"10px 16px",borderRadius:"4px",cursor:"pointer",fontSize:"14px"},children:"キャンセル"}),(0,n.jsx)("button",{onClick:eG,disabled:!ed.trim(),style:{backgroundColor:ed.trim()?"#5865f2":"#4f545c",border:"none",color:"white",padding:"10px 16px",borderRadius:"4px",cursor:ed.trim()?"pointer":"not-allowed",fontSize:"14px"},children:"招待"})]})]})}),er&&y&&"dm"!==y.id&&(0,n.jsx)(Q,{server:y,currentUser:e,onClose:()=>en(!1)}),eo&&(0,n.jsx)(P,{onUpload:e=>{eu(e),ei(!1)},onClose:()=>ei(!1)})]}),(0,n.jsx)(Z,{user:e}),eb&&(null==w?void 0:w.type)==="voice"&&(0,n.jsx)(q,{channel:w,currentUser:e,isActive:eb,onParticipantsUpdate:e=>em(e),onSpeakingUsersUpdate:e=>ev(e),onMuteStateUpdate:e=>eC(e)})]})}function et(e){let{imageId:t}=e,[r,i]=(0,o.useState)(null),[l,s]=(0,o.useState)(!0);return((0,o.useEffect)(()=>{let e=async()=>{try{let e=await B(t);i(e)}catch(e){console.error("画像取得エラー:",e)}finally{s(!1)}};t&&e()},[t]),l)?(0,n.jsx)("div",{style:{width:"200px",height:"200px",backgroundColor:"#2f3136",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"#72767d"},children:"読み込み中..."}):r?(0,n.jsx)("img",{src:r.data,alt:r.name,style:{maxWidth:"400px",maxHeight:"300px",borderRadius:"8px",cursor:"pointer"},onClick:()=>window.open(r.data,"_blank")}):(0,n.jsx)("div",{style:{width:"200px",height:"200px",backgroundColor:"#2f3136",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"#72767d"},children:"画像を読み込めませんでした"})}r(3594)},2936:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return r(2617)}])}},e=>{e.O(0,[671,661,200,909,636,593,792],()=>e(e.s=2936)),_N_E=e.O()}]);